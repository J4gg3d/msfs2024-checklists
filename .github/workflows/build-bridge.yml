name: Build and Release Bridge

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 1.0.0)'
        required: false
        default: ''

# Note: This workflow requires SimConnect DLLs in bridge-server/MSFSBridge/libs/
# These DLLs come from the MSFS SDK and cannot be auto-downloaded.
#
# To create a release:
# 1. Build locally with MSFS SDK installed
# 2. Create a ZIP of the publish folder
# 3. Upload manually to GitHub Releases
#
# OR: Add SimConnect DLLs to libs/ folder and run this workflow manually

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for SimConnect DLLs
      id: check-dlls
      run: |
        $managedDll = "bridge-server/MSFSBridge/libs/Microsoft.FlightSimulator.SimConnect.dll"
        $nativeDll = "bridge-server/MSFSBridge/libs/SimConnect.dll"

        if ((Test-Path $managedDll) -and (Test-Path $nativeDll)) {
          Write-Host "SimConnect DLLs found in libs/ folder"
          echo "dlls_found=true" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "::error::SimConnect DLLs not found!"
          Write-Host "::error::Please add the following files to bridge-server/MSFSBridge/libs/:"
          Write-Host "::error::  - Microsoft.FlightSimulator.SimConnect.dll (from MSFS SDK)"
          Write-Host "::error::  - SimConnect.dll (from MSFS SDK)"
          Write-Host ""
          Write-Host "These DLLs are located in your MSFS SDK installation:"
          Write-Host "  [SDK Path]/SimConnect SDK/lib/managed/Microsoft.FlightSimulator.SimConnect.dll"
          Write-Host "  [SDK Path]/SimConnect SDK/lib/SimConnect.dll"
          exit 1
        }
      shell: pwsh

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore bridge-server/MSFSBridge/MSFSBridge.csproj

    - name: Build Release
      run: dotnet publish bridge-server/MSFSBridge/MSFSBridge.csproj -c Release -o ./publish --self-contained false

    - name: Create ZIP
      run: Compress-Archive -Path ./publish/* -DestinationPath ./MSFSBridge.zip
      shell: pwsh

    - name: Get version
      id: version
      run: |
        if ("${{ github.event.inputs.version }}" -ne "") {
          $ver = "${{ github.event.inputs.version }}"
        } else {
          $ver = Get-Date -Format 'yyyy.MM.dd-HHmm'
        }
        echo "version=$ver" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: bridge-${{ steps.version.outputs.version }}
        name: SimConnect Bridge ${{ steps.version.outputs.version }}
        body: |
          ## SimConnect Bridge

          Build vom ${{ steps.version.outputs.version }}

          ### Installation
          1. ZIP herunterladen und entpacken
          2. MSFS 2024 SDK installieren (Developer Mode → Help → SDK Installer)
          3. .NET 8 Runtime installieren (falls nicht vorhanden)
          4. `MSFSBridge.exe` starten

          ### Voraussetzungen
          - Windows 10/11
          - MSFS 2024 mit installiertem SDK
          - .NET 8 Runtime

          Vollständige Anleitung: [README](https://github.com/${{ github.repository }}#bridge-installation-step-by-step)
        files: ./MSFSBridge.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
